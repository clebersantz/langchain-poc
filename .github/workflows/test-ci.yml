name: tests 

on:
  pull_request:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || vars.OPENAI_API_KEY }}
      ODOO_URL: http://host.docker.internal:8069
      ODOO_DB: odoo_test
      ODOO_USER: admin
      ODOO_API_KEY: admin
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate OPENAI_API_KEY is configured
        run: |
          if [ -z "${OPENAI_API_KEY}" ]; then
            echo "OPENAI_API_KEY is required for CI AI-agent integration tests."
            exit 1
          fi

      - name: Prepare env file
        run: cp .env.example .env

      - name: Build docker compose image
        run: docker compose -f docker/docker-compose.yml build

      - name: Start Odoo test stack
        if: env.OPENAI_API_KEY != ''
        run: docker compose -p odoo-dev -f docker/docker-compose.test-odoo.yml up -d

      - name: Wait for Odoo test stack readiness
        if: env.OPENAI_API_KEY != ''
        run: |
          docker compose -f docker/docker-compose.yml run --rm --no-deps \
            -e ODOO_URL="${ODOO_URL}" \
            -e ODOO_DB="${ODOO_DB}" \
            -e ODOO_USER="${ODOO_USER}" \
            -e ODOO_API_KEY="${ODOO_API_KEY}" \
            agent-app python - <<'PY'
          import time

          from app.odoo.client import OdooClient

          client = OdooClient()
          deadline = time.time() + 120
          while time.time() < deadline:
              try:
                  client.get_version()
                  print("Odoo is ready")
                  break
              except Exception:
                  time.sleep(2)
          else:
              raise SystemExit("Odoo test stack did not become ready in time")
          PY

      - name: Run tests in docker compose image
        run: docker compose -f docker/docker-compose.yml run --rm --no-deps agent-app pytest tests/unit

      - name: Start agent-app service
        run: docker compose -f docker/docker-compose.yml up -d agent-app

      - name: Verify static frontend from inside agent-app
        run: |
          set -euo pipefail
          echo "Starting inside-container static check: http://127.0.0.1:8000/static/index.html"
          docker compose -f docker/docker-compose.yml exec -T agent-app python - <<'PY'
          import time
          import urllib.request

          url = "http://127.0.0.1:8000/static/index.html"
          deadline = time.time() + 60
          last_error = ""
          attempt = 0
          while time.time() < deadline:
              attempt += 1
              try:
                  with urllib.request.urlopen(url, timeout=5) as response:
                      if response.status != 200:
                          last_error = f"unexpected response: status={response.status}"
                          print(f"Inside check attempt {attempt}: {last_error}")
                          time.sleep(2)
                          continue
                      body = response.read().decode("utf-8", errors="ignore")
                  if "CRM Assistant" in body:
                      print(f"Inside check PASSED on attempt {attempt}: status=200 marker=found")
                      raise SystemExit(0)
                  last_error = "expected marker not found in response body"
                  print(f"Inside check attempt {attempt}: {last_error}")
              except Exception as exc:
                  last_error = str(exc)
                  print(f"Inside check attempt {attempt}: error={last_error}")
              time.sleep(2)
          raise SystemExit(
              f"Inside check FAILED after {attempt} attempts: unable to access {url}: {last_error}"
          )
          PY

      - name: Verify host access to static frontend
        run: |
          set -euo pipefail
          url="http://localhost:8000/static/index.html"
          echo "Starting host-side static check: ${url}"
          for attempt in $(seq 1 30); do
            status_code="$(curl -s --connect-timeout 2 --max-time 5 -o /tmp/static-index.html -w '%{http_code}' "${url}" || printf '000')"
            marker_present="no"
            if grep -q "CRM Assistant" /tmp/static-index.html; then
              marker_present="yes"
            fi
            echo "Host check attempt ${attempt}: status=${status_code} marker=${marker_present}"
            if [ "${status_code}" = "200" ] && [ "${marker_present}" = "yes" ]; then
              echo "Host check PASSED on attempt ${attempt}: status=200 marker=found"
              exit 0
            fi
            sleep 2
          done
          echo "Host check FAILED after 30 attempts: unable to access ${url} with expected content"
          docker compose -f docker/docker-compose.yml ps agent-app || true
          docker compose -f docker/docker-compose.yml logs agent-app || true
          exit 1

      - name: Run detailed Odoo connection test script
        run: |
          docker compose -f docker/docker-compose.yml run --rm --no-deps \
            -e ODOO_URL="${ODOO_URL}" \
            -e ODOO_DB="${ODOO_DB}" \
            -e ODOO_USER="${ODOO_USER}" \
            -e ODOO_API_KEY="${ODOO_API_KEY}" \
            agent-app python scripts/test_odoo_connection.py

      - name: Run AI-agent Odoo integration tests (detailed output)
        run: |
          docker compose -f docker/docker-compose.yml run --rm --no-deps \
            -e OPENAI_API_KEY="${OPENAI_API_KEY}" \
            -e ODOO_URL="${ODOO_URL}" \
            -e ODOO_DB="${ODOO_DB}" \
            -e ODOO_USER="${ODOO_USER}" \
            -e ODOO_API_KEY="${ODOO_API_KEY}" \
            agent-app pytest -s -vv -rs tests/integration/test_odoo_docker_crm.py

      - name: Cleanup docker compose resources
        if: always()
        run: |
          docker compose -f docker/docker-compose.yml down -v
          docker compose -p odoo-dev -f docker/docker-compose.test-odoo.yml down -v || true
